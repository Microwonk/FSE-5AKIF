<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Management</title>
    <link rel="stylesheet" href="bootstrap.min.css" />
    <script src="jquery-3.3.1.min.js"></script>
  </head>
  <body class="container mt-5">
    <h1>Studentenliste</h1>

    <table class="table" id="studentTable"></table>

    <a class="btn btn-primary mt-3" href="insertstudent.html"
      >Student hinzufügen</a
    >

    <script>
      login();

      // Login function
      async function login() {
        const loginData = {
          login: "admin",
          password: "admin",
        };

        try {
          const response = await fetch(
            "http://localhost:8080/api/v1/students/authenticate",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(loginData),
            }
          );
          const { access_token, refresh_token } = await response.json();
          console.log(access_token);

          // Store tokens securely
          localStorage.setItem("accessToken", access_token);
          localStorage.setItem("refreshToken", refresh_token);

          // Fetch data after successful login
          getAllData();
        } catch (error) {
          console.error("Login failed:", error);
        }
      }

      async function getAllData() {
        const accessToken = localStorage.getItem("accessToken");
        const table = document.getElementById("studentTable");
        try {
          const response = await fetch(
            "http://localhost:8080/api/v1/students/",
            {
              method: "GET",
              cache: "no-cache",
              headers: {
                Authorization: `Bearer ${accessToken}`,
                Accept: "application/json",
              },
            }
          );
          const data = await response.json();

          while (table.rows[0]) table.deleteRow(0); // alle rows entfernen
          let row = table.insertRow();
          row.insertCell(0).innerHTML = "ID";
          row.insertCell(1).innerHTML = "Name";
          row.insertCell(2).innerHTML = "PLZ";
          row.insertCell(3).innerHTML = "Aktion";

          data.forEach((student) => {
            let row = table.insertRow();
            row.insertCell(0).innerHTML = student.id;
            row.insertCell(1).innerHTML = student.name;
            row.insertCell(2).innerHTML = student.plz;
            row.insertCell(3).innerHTML =
              '<button type="button" class="btn btn-danger" onclick="deleteStudent(' +
              student.id +
              ')">Löschen</button>';
          });
        } catch (e) {
          console.error(e);
          table.innerHTML = "Studenten konnten nicht geladen werden";
        }
      }

      // Function to delete a student
      async function deleteStudent(id) {
        try {
          const accessToken = localStorage.getItem("accessToken");
          await fetch("http://localhost:8080/api/v1/students/" + id, {
            method: "DELETE",
            headers: {
              Authorization: `Bearer ${accessToken}`,
              Accept: "application/json",
            },
          });
          await getAllData();
        } catch (error) {
          console.error("Error deleting student:", error);
        }
      }
    </script>
  </body>
</html>
